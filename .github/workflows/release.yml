name: Release
on:
  push:
    tags:
    - 'v[0-9]+.[0-9]+.[0-9]+'

env:
  RUST_TOOLCHAIN: stable
  BIN_NAME: shellfirm
  PROJECT_NAME: shellfirm
  REPO_NAME: kaplanelad/shellfirm
  BREW_TAP: kaplanelad/homebrew-tap

jobs:
  validate:
    name: Validate release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      npm_ready: ${{ steps.npm-check.outputs.npm_ready }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract tag version
        id: version
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$TAG_VERSION" >> "$GITHUB_OUTPUT"

      - name: Verify Cargo.toml matches tag
        run: |
          CARGO_VERSION=$(grep -m1 '^version' shellfirm/Cargo.toml | sed 's/version *= *"\(.*\)"/\1/')
          TAG_VERSION="${{ steps.version.outputs.version }}"
          if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Cargo.toml version ($CARGO_VERSION) does not match tag (v$TAG_VERSION)"
            exit 1
          fi
          echo "Cargo.toml version matches tag: $CARGO_VERSION"

      - name: Check version not already released
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG_VERSION="${{ steps.version.outputs.version }}"
          if gh release view "v$TAG_VERSION" > /dev/null 2>&1; then
            echo "::error::Release v$TAG_VERSION already exists"
            exit 1
          fi
          echo "Version v$TAG_VERSION has not been released yet"

      - name: Check npm versions in sync
        id: npm-check
        run: |
          TAG_VERSION="${{ steps.version.outputs.version }}"
          ALL_MATCH=true
          for pkg in npm/shellfirm npm/cli-darwin-arm64 npm/cli-darwin-x64 npm/cli-linux-x64 npm/cli-win32-x64; do
            PKG_VERSION=$(node -p "require('./$pkg/package.json').version")
            if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
              echo "::warning::$pkg version ($PKG_VERSION) does not match tag (v$TAG_VERSION). Run scripts/bump-npm-version.sh"
              ALL_MATCH=false
            fi
          done
          echo "npm_ready=$ALL_MATCH" >> "$GITHUB_OUTPUT"

  dist:
    name: Dist
    needs: [validate]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        build: [x86_64-linux, x86_64-macos, aarch64-macos, x86_64-windows] # aarch64-linux,
        include:
        - build: x86_64-linux
          os: ubuntu-latest
          rust: stable
          target: x86_64-unknown-linux-gnu
          cross: false
          npm_pkg: cli-linux-x64
          binary: shellfirm
        # - build: aarch64-linux
        #   os: ubuntu-20.04
        #   rust: stable
        #   target: aarch64-unknown-linux-gnu
        #   cross: true
        - build: x86_64-macos
          os: macos-latest
          rust: stable
          target: x86_64-apple-darwin
          cross: false
          npm_pkg: cli-darwin-x64
          binary: shellfirm
        - build: aarch64-macos
          os: macos-latest
          rust: stable
          target: aarch64-apple-darwin
          cross: false
          npm_pkg: cli-darwin-arm64
          binary: shellfirm
        - build: x86_64-windows
          os: windows-latest
          rust: stable
          target: x86_64-pc-windows-msvc
          cross: false
          npm_pkg: cli-win32-x64
          binary: shellfirm.exe


    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }} 
          targets: ${{ matrix.target }}

      - name: Run cargo test
        if: matrix.build != 'aarch64-macos'
        run: cargo test --release --locked --target ${{ matrix.target }} 
       
      - name: Build release binary
        run: cargo build --release --locked --target ${{ matrix.target }}

      - name: Strip release binary (linux and macos)
        if: matrix.build == 'x86_64-linux' || matrix.build == 'x86_64-macos' || matrix.build == 'aarch64-macos'
        run: strip "target/${{ matrix.target }}/release/$BIN_NAME"

      - name: Strip release binary (arm)
        if: matrix.build == 'aarch64-linux'
        run: |
          docker run --rm -v \
            "$PWD/target:/target:Z" \
            rustembedded/cross:${{ matrix.target }} \
            aarch64-linux-gnu-strip \
            /target/${{ matrix.target }}/release/$BIN_NAME
      - name: Build archive
        shell: bash
        run: |
          mkdir dist
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            cp "target/${{ matrix.target }}/release/$BIN_NAME.exe" "dist/"
          else
            cp "target/${{ matrix.target }}/release/$BIN_NAME" "dist/"
          fi
      - uses: actions/upload-artifact@v4
        with:
          name: bins-${{ matrix.build }}
          path: dist

      - name: Copy binary to npm package
        shell: bash
        run: cp target/${{ matrix.target }}/release/${{ matrix.binary }} npm/${{ matrix.npm_pkg }}/

      - name: Upload npm artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.npm_pkg }}
          path: npm/${{ matrix.npm_pkg }}/

  publish-github:
    name: Publish to GitHub Releases
    needs: [dist]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          submodules: false

      - uses: actions/download-artifact@v4

      - run: ls -al bins-*

      - name: Calculate tag name
        run: |
          name=dev
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            name=${GITHUB_REF:10}
          fi
          echo ::set-output name=val::$name
          echo TAG=$name >> $GITHUB_ENV
        id: tagname

      - name: Build archive
        shell: bash
        run: |
          set -ex
          rm -rf tmp
          mkdir tmp
          mkdir dist
          for dir in bins-* ; do
              platform=${dir#"bins-"}
              if [[ $platform =~ "windows" ]]; then
                  exe=".exe"
              fi
              pkgname=$PROJECT_NAME-$TAG-$platform
              mkdir tmp/$pkgname
              # cp LICENSE README.md tmp/$pkgname
              mv bins-$platform/$BIN_NAME$exe tmp/$pkgname
              chmod +x tmp/$pkgname/$BIN_NAME$exe
              if [ "$exe" = "" ]; then
                  tar cJf dist/$pkgname.tar.xz -C tmp $pkgname
              else
                  (cd tmp && 7z a -r ../dist/$pkgname.zip $pkgname)
              fi
          done
      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/*
          file_glob: true
          tag: ${{ steps.tagname.outputs.val }}
          overwrite: true

  publish-brew:
    name: Publish to Homebrew
    needs: [publish-github]
    runs-on: ubuntu-latest
    steps:
      - name: Extract version
        id: extract-version
        run: |
          printf "::set-output name=%s::%s\n" tag-name "${GITHUB_REF#refs/tags/}"
      - uses: mislav/bump-homebrew-formula-action@v1
        with:
          formula-path: ${{env.PROJECT_NAME}}.rb
          homebrew-tap: ${{ env.BREW_TAP }}
          download-url: "https://github.com/${{ env.REPO_NAME }}/releases/download/${{ steps.extract-version.outputs.tag-name }}/${{env.PROJECT_NAME}}-${{ steps.extract-version.outputs.tag-name }}-x86_64-macos.tar.xz"
          commit-message: updating formula for ${{ env.PROJECT_NAME }}
        env:
          COMMITTER_TOKEN: ${{ secrets.COMMITTER_TOKEN }}

  publish-npm:
    name: Publish to npm
    needs: [validate, dist]
    if: needs.validate.outputs.npm_ready == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Download all npm artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare platform packages
        run: |
          for pkg in cli-darwin-arm64 cli-darwin-x64 cli-linux-x64 cli-win32-x64; do
            cp -r artifacts/$pkg/* npm/$pkg/
          done

      - name: Publish platform packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for pkg in cli-darwin-arm64 cli-darwin-x64 cli-linux-x64 cli-win32-x64; do
            npm publish ./npm/$pkg --access public
          done

      - name: Publish main package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish ./npm/shellfirm --access public
